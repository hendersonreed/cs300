<html>
<meta charset="utf-8" />
<head>
</head>
<script>localStorage.clear();</script>
<script src="mapLoad.js"></script>
<script src="cellLoad.js"></script>

<script>
	/*
		File: Frupal.html
		Author: Henderson Hummel
		Date 10/27/2018

		Purpose: display the game to user.
		Description: This is our managing javascript section, as well as the
		page source. It's exceedingly preliminary, so much of this will change.
		Also! This page is in active development, so if you're reading this 
		because the page is broken, well, that's to be expected.
	*/
const MAX = 20;
	var game = {
		x_coord : 0,
		y_coord : 0,
		energy : 100,
		jewels : {x: Math.round((Math.random() * 1000) % (MAX + 1)), y: Math.round((Math.random() * 1000) % (MAX + 1))},

		//setting up the initial cell contents div.
		go : function(direc) {
			switch(direc) {
				case 'n':
					this.goNorth();
					break;
				case 'e':
					this.goEast();
					break;
				case 'w':
					this.goWest();
					break;
				case 's':
					this.goSouth();
					break;
				default:
					this.y_coord = 0;
					this.x_coord = 0;
					break;
			}
			this.dispLoc();
			this.checkLoc();
			this.displayEnergy();
			if(this.atJewels())
				alert("You've found the jewels!");
		},

		dispLoc : function() {
			document.getElementById("loc").innerHTML = "Current Location:  " + this.x_coord + ',' + this.y_coord;
		},

		checkLoc : function() {
			var cellContents = localStorage.getItem(this.x_coord + ',' + this.y_coord);
			if(cellContents != null) {
				document.getElementById("cell").innerHTML = "Cell Details: " + cellContents;
			}
			else {
				document.getElementById("cell").innerHTML = "Cell Details: 0,0,0,0,None";
			}
		},

		atJewels : function() {
			if((this.x_coord == this.jewels.x) && (this.y_coord == this.jewels.y))
				return true;
			return false
		},
		
		goNorth : function() {
			if(this.x_coord > 0) {
				--this.x_coord;
			}
			else {
				this.x_coord = MAX;
			}
			this.checkEnergy();
			this.updateVisibility();
			this.displayMap();
		},

		goEast : function() {
			if(this.y_coord < MAX) {
				++this.y_coord;
			}
			else {
				this.y_coord = 0;
			}
			this.checkEnergy();
			this.updateVisibility();
			this.displayMap();
		},

		goWest : function() {
			if(this.y_coord > 0) {
				--this.y_coord;
			}
			else {
				this.y_coord = MAX;
			}
			this.checkEnergy();
			this.updateVisibility();
			this.displayMap();
		},

		goSouth : function() {
			if(this.x_coord < MAX) {
				++this.x_coord;
			}
			else {
				this.x_coord = 0;
			}
			this.checkEnergy();
			this.updateVisibility();
			this.displayMap();
		},

		displayEnergy : function() {
			document.getElementById("energy").innerHTML = "Energy: " + this.energy;
		},
		checkEnergy : function() {
			cellContents = localStorage.getItem(this.x_coord + ',' + this.y_coord);
			if(cellContents != null)
			{	
				var cell = cellContents.split(',');
				if((cell[3] == 4) || (cell[3] == 5))
					this.energy = this.energy-2;
				else
					--this.energy;
			}
			else
				--this.energy;
			if(this.energy < 1) {
				alert("You are out of energy!");
				this.gameOver();
			}
		},

		gameOver : function() {
		
			window.location.reload(false);
		},
		displayMap : function() {
			var DISPLAYSIZE = 11;
			var x = [0];
			var y = [0];
			var i,j;
			var horizBuffer = 5;
			var vertBuffer = 5;
			if(this.x_coord < horizBuffer)
				x[0] = this.x_coord + MAX-(horizBuffer-1);
			else
				x[0] = this.x_coord - horizBuffer;
			
			for(i = 1;i<DISPLAYSIZE;++i)
			{
				if(x[i-1] < MAX)
					x[i] = (x[i-1]+1);
				else
					x[i] = 0;
			}
			
			if(this.y_coord < vertBuffer)
				y[0] = this.y_coord + MAX-(vertBuffer-1);
			else
				y[0] = this.y_coord - vertBuffer;
			
			for(i = 1;i<DISPLAYSIZE;++i)
			{
				if(y[i-1] < MAX)
					y[i] = (y[i-1]+1);
				else
					y[i] = 0;
			}
			console.log(x);
			console.log(y);
			var mapString = "";
			var mapRow = "";
			var currentCell;
			for(i = 0;i < y.length; i++)
			{
				for(j = 0;j < x.length; j++)
				{
					if((x[j] == this.x_coord) && (y[i] == this.y_coord))
						mapString += "[H] ";
					else
					{
						currentCell = localStorage.getItem(x[i] + ',' + y[j]);		
						if(currentCell != null)
						{
							currentCell = currentCell.split(',');
							mapString += '[';
							if(currentCell[2] == 0)
								mapString += 'X';
							else if(currentCell[3] == 0)
								mapString += 'M';
							else if(currentCell[3] == 1)
								mapString += 'F';
							else if(currentCell[3] == 2)
								mapString += '~';
							else if(currentCell[3] == 3)
								mapString += 'W';
							else if(currentCell[3] == 4)
								mapString += 'B';
							else
								mapString += 'S';

							mapString += "] ";
						
						}

						else
							mapString += "[X] ";
					}
				}
				mapRow = "map" + i;
				document.getElementById(mapRow).innerHTML = mapString;
				mapString = "";
			}

				
		},

		updateVisibility : function() 
		{
			x_cells = [];
			y_cells = [];
			var key = "";
			var newCell = "";

			if(this.x_coord == 0)
				x_cells[0] = 20;
			else
				x_cells[0] = this.x_coord-1;
			x_cells[1] = this.x_coord;
			if(this.x_coord == 20)
				x_cells[2] = 0;
			else
				x_cells[2] = this.x_coord+1;

			if(this.y_coord == 0)
				y_cells[0] = 20;
			else
				y_cells[0] = this.y_coord-1;
			
			y_cells[1] = this.y_coord;
			
			if(this.y_coord == 20)
				y_cells[2] = 0;
			else
				y_cells[2] = this.y_coord+1;

			for(i=0;i<x_cells.length;++i)
			{
				for(j=0;j<y_cells.length;++j)
				{
					key = (x_cells[i] + ',' + y_cells[j]);
					cellContents = localStorage.getItem(key);
					if(cellContents != null)
					{
						cellContents = cellContents.split(',');
						cellContents[2] = 1;
						newCell = cellContents[0] + ',' + cellContents[1] + ',' + cellContents[2] + ',' + cellContents[3] +',' + cellContents[4];
						localStorage.setItem(key, newCell);
					}
					else
					{
						newCell = x_cells[i] + ',' + y_cells[j] + ",1,0,None";
						localStorage.setItem(key, newCell);
					}

						
				}
			}
			
		},
			

	};
</script>

<body>
<h1>Frupal - the game ...</h1>
<br><br>
<div style="width:25%;">
	<div>
	<div align="middle">
		<button onclick="game.go('n')" type="submit" form="form1" value="Submit">NORTH</button>
	</div>
	<div align="left">
		<button onclick="game.go('e')" style="float:right" type="submit" form="form1" value="Submit">EAST</button>
		<button onclick="game.go('w')" type="submit" form="form1" value="Submit">WEST</button>
	</div>
	<div align="middle">
		<button onclick="game.go('s')" type="submit" form="form1" value="Submit">SOUTH</button>
	</div>
</div>
<br><br><br>

<div><p id="loc">Current Location:  0,0</p> </div>
<div><p id="cell">Cell Details: </p> </div>
<div><p id="whif">Whiffles: </p> </div>
<div><p id="energy">Energy: </p> </div>
<div>Key: H=Hero X=Unexplored M=Meadow F=Forest ~=Water W=Wall B=Bog S=Swamp</div> 
<div id="map" style="font-size:90%;text-align:justify;width="1500px""> 
	<p id="map0"></p>
	<p id="map1"></p>
	<p id="map2"></p>
	<p id="map3"></p>
	<p id="map4"></p>
	<p id="map5"></p>
	<p id="map6"></p>
	<p id="map7"></p>
	<p id="map8"></p>
	<p id="map9"></p>
	<p id="map10"></p>
</div>

	<script>
		
		console.log(game.jewels.x + ',' + game.jewels.y);
		game.checkLoc(); //displaying the cell contents of the initial location.
		game.displayEnergy();
		game.updateVisibility();
		game.displayMap();
	</script>

</body>

</html>
